name: PowerShell Script Validation

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'scripts/**/*.ps1'
      - 'tests/**/*.ps1'
      - '.github/workflows/powershell-validation.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'scripts/**/*.ps1'
      - 'tests/**/*.ps1'

jobs:
  validate:
    runs-on: windows-latest
    name: Validate PowerShell Scripts

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set execution policy
        shell: pwsh
        run: Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope Process -Force

      - name: Run PSScriptAnalyzer
        shell: pwsh
        run: |
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser
          $scripts = Get-ChildItem -Path . -Include *.ps1 -Recurse
          foreach ($script in $scripts) {
            Write-Host "Analyzing: $($script.FullName)"
            Invoke-ScriptAnalyzer -Path $script.FullName -Severity Warning
          }

      - name: Validate Script Syntax
        shell: pwsh
        run: |
          $scripts = Get-ChildItem -Path . -Include *.ps1 -Recurse | Where-Object { $_.Name -notlike "*.tests.ps1" }
          $errors = 0
          foreach ($script in $scripts) {
            Write-Host "Checking syntax: $($script.FullName)"
            try {
              $ps = [System.Management.Automation.PSParser]::Tokenize((Get-Content $script.FullName -Raw), [ref]$null)
              Write-Host "✓ Syntax OK"
            } catch {
              Write-Host "✗ Syntax Error: $_"
              $errors++
            }
          }
          if ($errors -gt 0) { exit 1 }

      - name: Run Pester Tests
        shell: pwsh
        run: |
          # Install Pester if not available
          if ($null -eq (Get-Module -Name Pester -ListAvailable)) {
            Install-Module -Name Pester -Force -Scope CurrentUser
          }
          
          # Discover all test files
          $testPath = './tests'
          
          if ((Test-Path $testPath) -and (Get-ChildItem -Path $testPath -Include "*.tests.ps1" -Recurse)) {
            Write-Host "Running Pester tests with modern Pester 5.x configuration..."
            
            # Create Pester configuration using modern Pester 5.x approach
            $config = New-PesterConfiguration
            $config.Run.Path = $testPath
            $config.Run.PassThru = $true
            $config.Output.Verbosity = 'Detailed'
            $config.TestResult.Enabled = $true
            $config.TestResult.OutputPath = "${{ runner.temp }}/TEST-Results.xml"
            $config.TestResult.OutputFormat = 'NUnitXml'
            
            # Run tests with modern configuration
            $results = Invoke-Pester -Configuration $config
            
            # Exit with error code if tests failed
            if ($results.FailedCount -gt 0) {
              exit 1
            }
          } else {
            Write-Host "No test files found in tests/ directory (*.tests.ps1)"
          }

      - name: Publish Test Results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results
          path: ${{ runner.temp }}/TEST-Results.xml
          retention-days: 30
