name: PowerShell Script Validation

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'scripts/**/*.ps1'
      - '.github/workflows/powershell-validation.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'scripts/**/*.ps1'

jobs:
  validate:
    runs-on: windows-latest
    name: Validate PowerShell Scripts

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set execution policy
        shell: pwsh
        run: Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope Process -Force

      - name: Run PSScriptAnalyzer
        shell: pwsh
        run: |
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser
          $scripts = Get-ChildItem -Path . -Include *.ps1 -Recurse
          foreach ($script in $scripts) {
            Write-Host "Analyzing: $($script.FullName)"
            Invoke-ScriptAnalyzer -Path $script.FullName -Severity Warning
          }

      - name: Validate Script Syntax
        shell: pwsh
        run: |
          $scripts = Get-ChildItem -Path . -Include *.ps1 -Recurse
          $errors = 0
          foreach ($script in $scripts) {
            Write-Host "Checking syntax: $($script.FullName)"
            try {
              $ps = [System.Management.Automation.PSParser]::Tokenize((Get-Content $script.FullName -Raw), [ref]$null)
              Write-Host "✓ Syntax OK"
            } catch {
              Write-Host "✗ Syntax Error: $_"
              $errors++
            }
          }
          if ($errors -gt 0) { exit 1 }
