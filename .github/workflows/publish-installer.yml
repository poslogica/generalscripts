name: Build and Publish Winget Updater Installer

on:
  workflow_run:
    workflows: ["PowerShell Script Validation"]
    types:
      - completed
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  build-installer:
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    runs-on: windows-latest
    name: Build Winget Updater ZIP Package

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for tags

      - name: Get Next Version from GitHub Releases
        id: version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: pwsh
        run: |
          Write-Host "Determining next version from GitHub tags..." -ForegroundColor Cyan
          
          # Get the latest release tag from GitHub
          $latestRelease = gh release list --limit 1 --json tagName --jq '.[0].tagName' 2>$null
          
          if ($latestRelease -and $latestRelease -match '^v?\d+\.\d+\.\d+$') {
            $latestVersion = $latestRelease -replace '^v', ''
            Write-Host "Latest release tag: $latestRelease" -ForegroundColor Gray
          } else {
            # Fallback: check git tags directly
            $latestTag = git tag -l 'v*' --sort=-v:refname | Select-Object -First 1
            if ($latestTag -and $latestTag -match '^v?\d+\.\d+\.\d+$') {
              $latestVersion = $latestTag -replace '^v', ''
              Write-Host "Latest git tag: $latestTag" -ForegroundColor Gray
            } else {
              $latestVersion = "0.0.0"
              Write-Host "No existing tags found, starting from v0.0.0" -ForegroundColor Yellow
            }
          }
          
          # Parse and increment patch version
          $parts = $latestVersion -split '\.'
          [int]$major = $parts[0]
          [int]$minor = $parts[1]
          [int]$patch = $parts[2]
          $patch++
          
          $newVersion = "$major.$minor.$patch"
          $newTag = "v$newVersion"
          
          Write-Host "Next version: $newVersion (tag: $newTag)" -ForegroundColor Green
          
          # Set outputs for subsequent steps
          Add-Content -Path $env:GITHUB_OUTPUT "version=$newVersion"
          Add-Content -Path $env:GITHUB_OUTPUT "tag=$newTag"
          Add-Content -Path $env:GITHUB_ENV "VERSION=$newVersion"
          Add-Content -Path $env:GITHUB_ENV "TAG=$newTag"

      - name: Build Winget Updater ZIP package
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          Write-Host "Building Winget Updater v$version..." -ForegroundColor Cyan

          # Change to installer directory
          Set-Location -Path ./installer

          # Build the package with version in filename
          $outputPath = "${{ runner.temp }}/dist"
          New-Item -ItemType Directory -Path $outputPath -Force | Out-Null

          $zipName = "winget-updater-setup-v$version.zip"
          .\create-installer-package.ps1 -OutputPath $outputPath -Version $version

          # Verify ZIP was created
          $zipPath = Join-Path $outputPath $zipName
          if (Test-Path $zipPath) {
            $fileSize = (Get-Item $zipPath).Length / 1MB
            Write-Host "✓ ZIP package created: $zipPath" -ForegroundColor Green
            Write-Host "  Size: $($fileSize.ToString('F2')) MB"
            # Store for later steps
            Add-Content -Path $env:GITHUB_ENV "ZIP_NAME=$zipName"
            Add-Content -Path $env:GITHUB_ENV "ZIP_PATH=$zipPath"
          } else {
            Write-Error "Failed to create ZIP package at $zipPath"
            Get-ChildItem -Path $outputPath
            exit 1
          }

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $tagName = "${{ steps.version.outputs.tag }}"
          $zipPath = "${{ env.ZIP_PATH }}"
          $zipName = "${{ env.ZIP_NAME }}"
          $buildNum = "${{ github.run_number }}"
          $commitSha = "${{ github.sha }}".Substring(0, 7)
          $actor = "${{ github.actor }}"
          
          Write-Host "Creating GitHub Release $tagName..." -ForegroundColor Cyan
          
          # Build release notes
          $releaseNotes = "## Winget Updater $tagName`n`n"
          $releaseNotes += "Automated build of the Winget Updater installer package.`n`n"
          $releaseNotes += "### Installation`n"
          $releaseNotes += "1. Download ``$zipName```n"
          $releaseNotes += "2. Extract to desired location`n"
          $releaseNotes += "3. Run ``install-winget-updater.ps1`` as Administrator`n`n"
          $releaseNotes += "### Build Info`n"
          $releaseNotes += "- **Version**: $version`n"
          $releaseNotes += "- **Build**: #$buildNum`n"
          $releaseNotes += "- **Commit**: $commitSha`n"
          $releaseNotes += "- **Built by**: $actor"
          
          # Create release (this automatically creates the tag)
          gh release create $tagName `
            "$zipPath" `
            --title "Winget Updater $tagName" `
            --notes "$releaseNotes" `
            --target ${{ github.sha }}
          
          if ($LASTEXITCODE -eq 0) {
            Write-Host "✓ GitHub Release $tagName created successfully" -ForegroundColor Green
          } else {
            Write-Error "Failed to create GitHub Release"
            exit 1
          }

      - name: Update README with Latest Version
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $readmePath = "./README.md"
          
          Write-Host "Updating README with version $version..." -ForegroundColor Cyan
          
          # Read README content
          $content = Get-Content $readmePath -Raw
          
          # Update the version line (replace existing or add if missing)
          $pattern = '\*\*Latest Update\*\*:\s+v[\d.]+\s+with improved documentation and user guides\.'
          $replacement = "**Latest Update**: v$version with improved documentation and user guides."
          
          if ($content -match $pattern) {
            $content = $content -replace $pattern, $replacement
            Write-Host "✓ Updated existing version reference" -ForegroundColor Green
          } else {
            Write-Host "⚠ Version reference not found in README, skipping update" -ForegroundColor Yellow
          }
          
          # Write updated content back
          Set-Content -Path $readmePath -Value $content
          
          # Commit and push if there are changes
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add $readmePath
          
          if (git diff --cached --quiet) {
            Write-Host "✓ README already up to date" -ForegroundColor Green
          } else {
            # Fetch latest to handle any concurrent pushes
            git fetch origin main
            
            # Rebase on remote to avoid conflicts
            git rebase origin/main
            
            # Create commit with changes
            git commit -m "docs: Update README with latest version v$version [skip ci]"
            
            # Push with retry logic (up to 3 attempts)
            $maxRetries = 3
            $retryCount = 0
            $pushed = $false
            
            while ($retryCount -lt $maxRetries -and -not $pushed) {
              $retryCount++
              Write-Host "Push attempt $retryCount of $maxRetries..."
              
              git push origin HEAD:main
              
              if ($LASTEXITCODE -eq 0) {
                Write-Host "✓ README updated and pushed successfully" -ForegroundColor Green
                $pushed = $true
              } else {
                if ($retryCount -lt $maxRetries) {
                  Write-Host "⚠ Push failed, retrying after fetch..." -ForegroundColor Yellow
                  Start-Sleep -Seconds 2
                  git fetch origin main
                  git rebase origin/main
                }
              }
            }
            
            if (-not $pushed) {
              Write-Warning "Failed to push README update after $maxRetries attempts, but release was successful"
            }
          }

      - name: Publish Installer Artifact
        uses: actions/upload-artifact@v4
        with:
          name: winget-updater-setup-v${{ steps.version.outputs.version }}
          path: ${{ env.ZIP_PATH }}
          retention-days: 90
          compression-level: 0

