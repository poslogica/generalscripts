name: Build and Publish Winget Updater Installer

on:
  workflow_run:
    workflows: ["PowerShell Script Validation"]
    types:
      - completed
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  build-installer:
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    runs-on: windows-latest
    name: Build Winget Updater ZIP Package

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Winget Updater ZIP package
        shell: pwsh
        run: |
          Write-Host "Building Winget Updater distribution package..." -ForegroundColor Cyan

          # Change to installer directory
          Set-Location -Path ./installer

          # Read version from VERSION file
          $versionFile = './VERSION'
          $versionContent = Get-Content -Path $versionFile -Raw
          $versionMatch = $versionContent | Select-String -Pattern '^\d+\.\d+\.\d+' -AllMatches
          $version = if ($versionMatch.Matches) { $versionMatch.Matches[0].Value } else { '1.0.0' }

          Write-Host "Version: $version" -ForegroundColor Green

          # Build the package with version in filename
          $outputPath = "${{ runner.temp }}/dist"
          New-Item -ItemType Directory -Path $outputPath -Force | Out-Null

          $zipName = "winget-updater-setup-v$version.zip"
          .\create-installer-package.ps1 -OutputPath $outputPath -Version $version

          # Verify ZIP was created
          $zipPath = Join-Path $outputPath $zipName
          if (Test-Path $zipPath) {
            $fileSize = (Get-Item $zipPath).Length / 1MB
            Write-Host "✓ ZIP package created: $zipPath" -ForegroundColor Green
            Write-Host "  Size: $($fileSize.ToString('F2')) MB"
            # Store version for later steps
            Add-Content -Path $env:GITHUB_ENV "ZIP_VERSION=$version"
            Add-Content -Path $env:GITHUB_ENV "ZIP_NAME=$zipName"
            Add-Content -Path $env:GITHUB_ENV "ZIP_PATH=$zipPath"
          } else {
            Write-Error "Failed to create ZIP package at $zipPath"
            Get-ChildItem -Path $outputPath
            exit 1
          }

      - name: Increment Version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: pwsh
        run: |
          Write-Host "Incrementing version for next build..." -ForegroundColor Cyan
          
          $versionFile = './installer/VERSION'
          $versionContent = Get-Content -Path $versionFile -Raw
          
          # Extract version using regex - look for standalone version number on a line
          if ($versionContent -match '(?m)^\d+\.\d+\.\d+$') {
            $currentVersion = $matches[0]
          } else {
            $currentVersion = '1.0.0'
          }
          
          # Parse version components
          $parts = $currentVersion -split '\.'
          [int]$major = $parts[0]
          [int]$minor = $parts[1]
          [int]$patch = $parts[2]
          
          # Increment patch version
          $patch++
          $newVersion = "$major.$minor.$patch"
          
          Write-Host "Version incremented: $currentVersion → $newVersion" -ForegroundColor Green
          
          # Update VERSION file with new version
          $updatedContent = $versionContent -replace '(?m)^\d+\.\d+\.\d+$', $newVersion
          Set-Content -Path $versionFile -Value $updatedContent
          
          # Check if file was actually modified
          $gitStatus = & git status --short
          if ($gitStatus -match $versionFile) {
            Write-Host "✓ VERSION file modified successfully" -ForegroundColor Green
            
            # Commit and push version update
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add $versionFile
            git commit -m "chore: Increment version to $newVersion after successful build"
            
            # Pull before push to avoid conflicts
            git pull --rebase origin main
            git push origin main
            
            Write-Host "✓ Version committed and pushed" -ForegroundColor Green
          } else {
            Write-Host "⚠ VERSION file not modified (no changes detected)" -ForegroundColor Yellow
          }

      - name: Publish Installer Artifact
        uses: actions/upload-artifact@v4
        with:
          name: winget-updater-setup-${{ env.ZIP_VERSION }}
          path: ${{ env.ZIP_PATH }}
          retention-days: 90
          compression-level: 0

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: pwsh
        run: |
          $version = "${{ env.ZIP_VERSION }}"
          $zipPath = "${{ env.ZIP_PATH }}"
          $zipName = "${{ env.ZIP_NAME }}"
          $buildNum = "${{ github.run_number }}"
          $commitSha = "${{ github.sha }}".Substring(0, 7)
          $actor = "${{ github.actor }}"
          
          Write-Host "Creating GitHub Release v$version..." -ForegroundColor Cyan
          
          # Check if release already exists
          $existingRelease = gh release view "v$version" 2>&1
          if ($LASTEXITCODE -eq 0) {
            Write-Host "⚠ Release v$version already exists, skipping creation" -ForegroundColor Yellow
          } else {
            # Create new release with the ZIP artifact
            $releaseNotes = @"
          ## Winget Updater v$version
          
          Automated build of the Winget Updater installer package.
          
          ### Installation
          1. Download ``$zipName``
          2. Extract to desired location
          3. Run ``install-winget-updater.ps1`` as Administrator
          
          ### Build Info
          - **Version**: $version
          - **Build**: #$buildNum
          - **Commit**: $commitSha
          - **Built by**: $actor
          "@
            
            gh release create "v$version" `
              "$zipPath" `
              --title "Winget Updater v$version" `
              --notes "$releaseNotes" `
              --target main
            
            if ($LASTEXITCODE -eq 0) {
              Write-Host "✓ GitHub Release v$version created successfully" -ForegroundColor Green
            } else {
              Write-Error "Failed to create GitHub Release"
              exit 1
            }
          }
